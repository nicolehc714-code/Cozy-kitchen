<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cozy Kitchen ‚Äî Rainy Night</title>
  <style>
    :root{
      --bg0:#061a2a;
      --bg1:#0b2a3e;
      --warm:#ffcc7a;
      --warm2:#ff8a5b;
      --glass: rgba(255,255,255,.08);
      --glass2: rgba(255,255,255,.12);
      --stroke: rgba(255,255,255,.14);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.68);
      --shadow: rgba(0,0,0,.42);
      --radius: 20px;
      --pad: 14px;
      --warmth: 0; /* updated in JS */
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Color Emoji", "Apple Color Emoji";
      color: var(--text);
      background: radial-gradient(1200px 700px at 50% 10%, rgba(255,200,120,.10), transparent 55%),
                  radial-gradient(900px 600px at 70% 30%, rgba(255,120,90,.08), transparent 55%),
                  linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    /* Rain overlay */
    .rain{
      position:fixed; inset:0;
      pointer-events:none;
      opacity:.55;
      mix-blend-mode: screen;
      filter: blur(.2px);
    }
    .rain::before, .rain::after{
      content:"";
      position:absolute; inset:-30%;
      background-image: repeating-linear-gradient(
        115deg,
        rgba(255,255,255,.0) 0px,
        rgba(255,255,255,.0) 6px,
        rgba(255,255,255,.06) 7px,
        rgba(255,255,255,.06) 8px
      );
      transform: rotate(0deg);
      animation: rainMove 1.2s linear infinite;
    }
    .rain::after{
      opacity:.6;
      animation-duration: .9s;
      filter: blur(.35px);
    }
    @keyframes rainMove{
      0%{ transform: translate3d(-2%, -2%, 0); }
      100%{ transform: translate3d(2%, 8%, 0); }
    }

    /* Vignette + warmth glow */
    .vignette{
      position:fixed; inset:0;
      pointer-events:none;
      background:
        radial-gradient(1100px 700px at 50% 12%, rgba(255,200,120,.10), transparent 55%),
        radial-gradient(900px 800px at 50% 60%, rgba(0,0,0,.35), rgba(0,0,0,.65));
      opacity:.55;
    }
    .warmGlow{
      position:fixed; inset:0;
      pointer-events:none;
      background: radial-gradient(900px 600px at 50% 55%, rgba(255,190,110,.18), transparent 60%);
      opacity: calc(var(--warmth) * 0.012);
      transition: opacity .35s ease;
      mix-blend-mode: screen;
    }

    .wrap{
      max-width: 920px;
      margin: 22px auto 30px;
      padding: 0 14px 26px;
    }

    .topbar{
      display:flex;
      justify-content:center;
      margin: 10px 0 16px;
    }
    .marquee{
      width:min(860px, 100%);
      border: 1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      border-radius: 999px;
      padding: 10px 16px;
      text-transform: uppercase;
      letter-spacing: .25em;
      font-size: 12px;
      color: rgba(255,255,255,.75);
      display:flex;
      gap:10px;
      justify-content:center;
      box-shadow: 0 14px 32px var(--shadow);
      backdrop-filter: blur(10px);
    }

    /* Main layout */
    .grid{
      display:grid;
      grid-template-columns: 1.2fr .9fr;
      gap: 14px;
      align-items:start;
    }
    @media (max-width: 880px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      border: 1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      border-radius: var(--radius);
      box-shadow: 0 18px 44px var(--shadow);
      backdrop-filter: blur(12px);
      overflow:hidden;
    }
    .cardPad{ padding: 14px; }

    /* Scene (window + counter + chef + pot) */
    .scene{
      position:relative;
      height: 520px;
      min-height: 520px;
    }
    @media (max-width: 880px){
      .scene{ height: 560px; min-height:560px; }
    }

    .window{
      position:absolute;
      left: 22px; right: 22px;
      top: 18px;
      height: 175px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.18);
      background:
        radial-gradient(220px 140px at 20% 40%, rgba(255,210,140,.20), transparent 70%),
        radial-gradient(260px 160px at 80% 45%, rgba(120,190,255,.10), transparent 72%),
        linear-gradient(180deg, rgba(10,25,40,.7), rgba(10,25,40,.2));
      overflow:hidden;
    }
    .window::after{
      content:"";
      position:absolute; inset:0;
      background-image: repeating-linear-gradient(
        100deg,
        rgba(255,255,255,.0) 0px,
        rgba(255,255,255,.0) 10px,
        rgba(255,255,255,.09) 11px,
        rgba(255,255,255,.09) 12px
      );
      opacity:.18;
    }
    .window .pane{
      position:absolute; inset:0;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 0;
    }
    .window .pane > div{
      border-right: 1px solid rgba(255,255,255,.14);
      border-bottom: 1px solid rgba(255,255,255,.14);
    }
    .window .pane > div:nth-child(2n){ border-right:none; }

    .counter{
      position:absolute;
      left: 22px; right: 22px;
      bottom: 18px;
      height: 250px;
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.14);
      background:
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)),
        radial-gradient(900px 260px at 50% 0%, rgba(255,210,140,.09), transparent 65%);
      overflow:hidden;
    }
    .counter::before{
      content:"";
      position:absolute; inset:0;
      background:
        linear-gradient(90deg, rgba(0,0,0,.0), rgba(0,0,0,.20) 50%, rgba(0,0,0,.0));
      opacity:.22;
      transform: translateX(-20%);
    }

    .cuttingBoard{
      position:absolute;
      left: 54px;
      bottom: 62px;
      width: 330px;
      height: 118px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.14);
      background:
        radial-gradient(300px 120px at 30% 35%, rgba(255,210,140,.10), transparent 70%),
        linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      box-shadow: 0 20px 40px rgba(0,0,0,.35);
    }
    @media (max-width: 520px){
      .cuttingBoard{ width: 280px; left: 28px; }
    }

    .pot{
      position:absolute;
      right: 56px;
      bottom: 64px;
      width: 200px;
      height: 130px;
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.18);
      background:
        linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      box-shadow: 0 20px 40px rgba(0,0,0,.35);
      display:flex;
      align-items:flex-end;
      justify-content:center;
      padding-bottom: 14px;
    }
    .pot::before{
      content:"";
      position:absolute;
      top: 16px; left: 16px; right: 16px;
      height: 26px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.12);
    }
    .pot .label{
      font-size: 12px;
      letter-spacing:.08em;
      color: rgba(255,255,255,.68);
      user-select:none;
    }
    .steam{
      position:absolute;
      left: 0; right: 0;
      bottom: 112px;
      height: 120px;
      pointer-events:none;
      opacity:.85;
    }
    .steam span{
      position:absolute;
      bottom: 0;
      width: 60px;
      height: 90px;
      left: 50%;
      transform: translateX(-50%);
      border-radius: 999px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.36), rgba(255,255,255,0) 65%);
      filter: blur(1px);
      animation: steamUp 2.6s ease-in-out infinite;
      opacity:.0;
    }
    .steam span:nth-child(2){ left: 42%; animation-delay:.35s; }
    .steam span:nth-child(3){ left: 58%; animation-delay:.65s; }
    @keyframes steamUp{
      0%{ transform: translate(-50%, 16px) scale(.9); opacity:0; }
      20%{ opacity:.55; }
      60%{ opacity:.25; }
      100%{ transform: translate(-50%, -55px) scale(1.15); opacity:0; }
    }

    .chef{
      position:absolute;
      left: 50%;
      bottom: 108px;
      transform: translateX(-50%);
      width: 230px;
      height: 210px;
      display:flex;
      align-items:center;
      justify-content:center;
      user-select:none;
    }
    /* simple ‚Äúsprite‚Äù style via CSS shapes (looks way better than emoji) */
    .chef .head{
      width: 92px; height: 92px;
      border-radius: 26px;
      background: radial-gradient(circle at 35% 30%, rgba(255,255,255,.18), rgba(0,0,0,.10) 65%),
                  linear-gradient(180deg, rgba(255,220,180,.9), rgba(255,200,150,.8));
      box-shadow: 0 18px 30px rgba(0,0,0,.22);
      position:relative;
      border: 1px solid rgba(255,255,255,.18);
    }
    .chef .hat{
      position:absolute;
      top:-54px; left: 50%;
      transform: translateX(-50%);
      width: 110px;
      height: 70px;
      border-radius: 24px 24px 18px 18px;
      background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(235,235,235,.78));
      border: 1px solid rgba(255,255,255,.22);
      box-shadow: 0 18px 30px rgba(0,0,0,.20);
    }
    .chef .hat::before{
      content:"";
      position:absolute;
      left: 10px; right: 10px; top: -22px;
      height: 34px;
      border-radius: 18px;
      background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(235,235,235,.74));
      border: 1px solid rgba(255,255,255,.20);
    }
    .chef .eyes{
      position:absolute;
      left: 0; right: 0;
      top: 34px;
      display:flex;
      gap: 18px;
      justify-content:center;
    }
    .chef .eyes i{
      width: 10px; height: 10px;
      border-radius: 999px;
      background: rgba(25,35,55,.72);
      box-shadow: 0 0 0 2px rgba(255,255,255,.08);
    }
    .chef .smile{
      position:absolute;
      width: 28px; height: 14px;
      left: 50%; top: 56px;
      transform: translateX(-50%);
      border-bottom: 3px solid rgba(25,35,55,.55);
      border-radius: 0 0 18px 18px;
      opacity:.7;
    }
    .chef .body{
      position:absolute;
      top: 86px;
      width: 160px;
      height: 120px;
      border-radius: 28px;
      background: linear-gradient(180deg, rgba(255,255,255,.18), rgba(255,255,255,.06));
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: 0 18px 30px rgba(0,0,0,.20);
    }
    .chef .apron{
      position:absolute;
      top: 102px;
      width: 120px;
      height: 100px;
      border-radius: 20px;
      background: linear-gradient(180deg, rgba(255,210,140,.15), rgba(255,210,140,.05));
      border: 1px solid rgba(255,255,255,.12);
    }
    .chef.chopAnim{
      animation: chopBob .18s ease-in-out 0s 2;
    }
    @keyframes chopBob{
      0%{ transform: translateX(-50%) translateY(0); }
      50%{ transform: translateX(-50%) translateY(6px); }
      100%{ transform: translateX(-50%) translateY(0); }
    }

    /* Order card */
    .orderRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }
    .orderTitle{
      font-size: 13px;
      letter-spacing:.08em;
      text-transform: uppercase;
      color: rgba(255,255,255,.65);
    }
    .orderMain{
      font-size: 34px;
      font-weight: 800;
      margin-top: 4px;
      line-height: 1.06;
    }
    .orderSub{
      color: rgba(255,255,255,.72);
      margin-top: 6px;
      font-size: 14px;
    }
    .ingredientIcon{
      width: 74px; height: 74px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.16);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 44px;
      box-shadow: 0 18px 30px rgba(0,0,0,.20);
    }

    /* Dialogue */
    .dialogue{
      display:flex;
      gap: 12px;
      align-items:center;
    }
    .portrait{
      width: 52px; height: 52px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.16);
      background:
        radial-gradient(circle at 35% 30%, rgba(255,210,140,.22), rgba(0,0,0,.12) 70%),
        linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 800;
      letter-spacing:.06em;
      color: rgba(255,255,255,.85);
      box-shadow: 0 16px 26px rgba(0,0,0,.20);
    }
    .dialogueText .name{
      font-weight: 800;
      color: var(--warm);
      margin-right: 8px;
    }
    .dialogueText .line{
      color: rgba(255,255,255,.88);
      font-style: italic;
    }

    /* Stats + buttons */
    .stats{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: 12px;
    }
    .stat{
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      border-radius: 16px;
      padding: 10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .stat .k{
      display:flex;
      align-items:center;
      gap: 8px;
      color: rgba(255,255,255,.75);
      font-size: 13px;
    }
    .stat .v{
      font-weight: 900;
      font-size: 16px;
      color: rgba(255,255,255,.92);
    }

    .btnRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 12px;
    }
    .btn{
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      border-radius: 16px;
      padding: 14px 14px;
      font-weight: 900;
      letter-spacing: .04em;
      color: rgba(255,255,255,.92);
      cursor:pointer;
      user-select:none;
      box-shadow: 0 18px 30px rgba(0,0,0,.20);
      transition: transform .08s ease, background .2s ease, border-color .2s ease;
    }
    .btn:active{ transform: translateY(1px) scale(.995); }
    .btn.primary{
      background: linear-gradient(180deg, rgba(255,204,122,.95), rgba(255,160,92,.85));
      color: rgba(20,30,45,.92);
      border-color: rgba(255,255,255,.20);
    }
    .btn.full{
      grid-column: 1 / -1;
      text-align:center;
    }
    .hint{
      margin-top: 8px;
      color: rgba(255,255,255,.62);
      font-size: 12px;
      text-align:center;
    }

    /* Right column: ‚ÄúNow playing / recipe vibe‚Äù */
    .sideTitle{
      font-weight: 900;
      letter-spacing:.08em;
      text-transform: uppercase;
      font-size: 12px;
      color: rgba(255,255,255,.70);
      margin-bottom: 10px;
    }
    .sideBig{
      font-size: 28px;
      font-weight: 900;
      line-height:1.1;
      margin: 0 0 10px;
    }
    .sideP{
      color: rgba(255,255,255,.74);
      line-height: 1.55;
      margin: 0 0 12px;
      font-size: 14px;
    }
    .pillRow{
      display:flex;
      flex-wrap:wrap;
      gap: 10px;
      margin-top: 12px;
    }
    .pill{
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      border-radius: 999px;
      padding: 8px 12px;
      color: rgba(255,255,255,.78);
      font-size: 13px;
    }
    .footerNote{
      margin-top: 14px;
      color: rgba(255,255,255,.55);
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div class="rain"></div>
  <div class="warmGlow"></div>
  <div class="vignette"></div>

  <div class="wrap">
    <div class="topbar">
      <div class="marquee">COZY KITCHEN ‚Ä¢ OPEN LATE ‚Ä¢ RAINY NIGHT</div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <div class="cardPad">
          <div class="orderRow">
            <div>
              <div class="orderTitle">Order</div>
              <div class="orderMain" id="orderText">Tomato √ó 3</div>
              <div class="orderSub" id="orderSub">Keep your rhythm.</div>
            </div>
            <div class="ingredientIcon" id="ingredientIcon">üçÖ</div>
          </div>
        </div>

        <div class="scene" id="scene">
          <div class="window">
            <div class="pane">
              <div></div><div></div><div></div><div></div>
            </div>
          </div>

          <div class="counter"></div>

          <div class="cuttingBoard"></div>

          <div class="pot" id="pot">
            <div class="steam" id="steam">
              <span></span><span></span><span></span>
            </div>
            <div class="label" id="potLabel">simmer‚Ä¶</div>
          </div>

          <div class="chef" id="chef">
            <div class="head">
              <div class="hat"></div>
              <div class="eyes"><i></i><i></i></div>
              <div class="smile"></div>
            </div>
            <div class="body"></div>
            <div class="apron"></div>
          </div>
        </div>

        <div class="cardPad">
          <div class="dialogue">
            <div class="portrait">M</div>
            <div class="dialogueText">
              <div><span class="name">Mara</span> <span class="line" id="line">‚ÄúRain makes the kitchen feel quieter.‚Äù</span></div>
            </div>
          </div>

          <div class="stats">
            <div class="stat">
              <div class="k">üß° Warmth</div>
              <div class="v" id="warmth">0</div>
            </div>
            <div class="stat">
              <div class="k">üí∞ Tips</div>
              <div class="v" id="tips">0</div>
            </div>
            <div class="stat">
              <div class="k">üî• Streak</div>
              <div class="v" id="streak">0</div>
            </div>
          </div>

          <div class="btnRow">
            <button class="btn primary" id="chopBtn">CHOP</button>
            <button class="btn" id="newBtn">New Ingredient</button>
            <button class="btn full" id="lofiBtn">üéß Lo-fi (tap to enable)</button>
          </div>
          <div class="hint" id="hint">Tip: Tap CHOP in rhythm. Warmth builds the glow.</div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <div class="cardPad">
          <div class="sideTitle">Tonight‚Äôs vibe</div>
          <div class="sideBig">A warm kitchen, rain on the window, soft music.</div>
          <p class="sideP">
            This is a <b>playable prototype</b> that feels cozy. Next step after this:
            we swap the ‚Äústylized‚Äù chef into real illustrated sprites, add customers
            sliding into the booth, and give Mara a few more lines + reactions.
          </p>
          <div class="pillRow">
            <div class="pill">üåßÔ∏è Rainy ambience</div>
            <div class="pill">üî• Steam + simmer</div>
            <div class="pill">üß° Warmth glow</div>
            <div class="pill">üéß Lo-fi toggle</div>
          </div>
          <div class="footerNote">
            If you want ‚Äúreal characters + restaurant interior art‚Äù, we‚Äôll add an <code>/assets</code> folder next and drop in images.
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  // --------- Game State ----------
  const ingredients = [
    {name:"Tomato", icon:"üçÖ", sub:"Keep your rhythm."},
    {name:"Mushroom", icon:"üçÑ", sub:"Last one. Make it nice."},
    {name:"Garlic", icon:"üßÑ", sub:"Small cuts. Big flavor."},
    {name:"Carrot", icon:"ü•ï", sub:"Comfort in slices."},
    {name:"Onion", icon:"üßÖ", sub:"Tears mean it matters."},
    {name:"Herbs", icon:"üåø", sub:"A quiet finishing touch."}
  ];

  const lines = [
    "‚ÄúRain makes the kitchen feel quieter.‚Äù",
    "‚ÄúThe stove light is my favorite kind of glow.‚Äù",
    "‚ÄúChop slow. Let it feel like a ritual.‚Äù",
    "‚ÄúThe city is loud. In here, we simmer.‚Äù",
    "‚ÄúOne good dish can change a whole day.‚Äù"
  ];

  let current = 0;
  let qty = 3;

  let warmth = 0;
  let tips = 0;
  let streak = 0;

  // --------- Elements ----------
  const orderText = document.getElementById("orderText");
  const orderSub  = document.getElementById("orderSub");
  const ingredientIcon = document.getElementById("ingredientIcon");
  const lineEl = document.getElementById("line");

  const warmthEl = document.getElementById("warmth");
  const tipsEl = document.getElementById("tips");
  const streakEl = document.getElementById("streak");

  const chef = document.getElementById("chef");
  const potLabel = document.getElementById("potLabel");
  const steam = document.getElementById("steam");

  const chopBtn = document.getElementById("chopBtn");
  const newBtn = document.getElementById("newBtn");
  const lofiBtn = document.getElementById("lofiBtn");

  function render(){
    const ing = ingredients[current];
    orderText.textContent = `${ing.name} √ó ${qty}`;
    orderSub.textContent = ing.sub;
    ingredientIcon.textContent = ing.icon;

    warmthEl.textContent = warmth;
    tipsEl.textContent = tips;
    streakEl.textContent = streak;

    // warm glow intensity
    document.documentElement.style.setProperty("--warmth", warmth);

    // simmer label mood
    potLabel.textContent = warmth > 30 ? "simmer‚Ä¶ (cozy)" : "simmer‚Ä¶";

    // steam more visible with warmth
    const op = Math.min(.95, .35 + warmth * 0.012);
    steam.style.opacity = op.toFixed(2);

    lineEl.textContent = lines[(warmth + tips + streak) % lines.length];
  }

  // --------- Chop action ----------
  let lastChopAt = 0;
  chopBtn.addEventListener("click", ()=>{
    // animation
    chef.classList.remove("chopAnim");
    void chef.offsetWidth;
    chef.classList.add("chopAnim");

    // ‚Äúrhythm‚Äù scoring: reward chops spaced ~350‚Äì650ms
    const now = performance.now();
    const dt = now - lastChopAt;
    lastChopAt = now;

    let bonus = 0;
    if(dt > 350 && dt < 650) bonus = 2;
    else if(dt > 220 && dt < 900) bonus = 1;

    streak = Math.min(99, streak + (bonus ? 1 : 0));
    warmth = Math.min(100, warmth + 2 + bonus);
    tips = Math.min(999, tips + 1 + bonus);

    qty -= 1;
    if(qty <= 0){
      // next order
      tips += 4;
      warmth = Math.min(100, warmth + 6);
      streak = Math.min(99, streak + 1);
      current = (current + 1) % ingredients.length;
      qty = 1 + Math.floor(Math.random() * 4);
    }
    render();
  });

  newBtn.addEventListener("click", ()=>{
    current = (current + 1) % ingredients.length;
    qty = 1 + Math.floor(Math.random() * 4);
    streak = Math.max(0, streak - 1);
    render();
  });

  // --------- Lo-fi (WebAudio) ----------
  let audioOn = false;
  let ctx, master, drone, beatTimer;

  function startLofi(){
    if(audioOn) return;
    audioOn = true;

    ctx = new (window.AudioContext || window.webkitAudioContext)();

    master = ctx.createGain();
    master.gain.value = 0.20; // overall volume
    master.connect(ctx.destination);

    // Soft ‚Äútape‚Äù hiss
    const noiseBuf = ctx.createBuffer(1, ctx.sampleRate * 2, ctx.sampleRate);
    const data = noiseBuf.getChannelData(0);
    for(let i=0;i<data.length;i++){
      data[i] = (Math.random()*2-1) * 0.12;
    }
    const noise = ctx.createBufferSource();
    noise.buffer = noiseBuf;
    noise.loop = true;

    const noiseFilter = ctx.createBiquadFilter();
    noiseFilter.type = "lowpass";
    noiseFilter.frequency.value = 900;

    const noiseGain = ctx.createGain();
    noiseGain.gain.value = 0.05;

    noise.connect(noiseFilter);
    noiseFilter.connect(noiseGain);
    noiseGain.connect(master);
    noise.start();

    // Warm chord drone
    drone = ctx.createOscillator();
    drone.type = "triangle";
    drone.frequency.value = 196; // G3-ish

    const droneGain = ctx.createGain();
    droneGain.gain.value = 0.06;

    const droneLP = ctx.createBiquadFilter();
    droneLP.type = "lowpass";
    droneLP.frequency.value = 700;

    drone.connect(droneLP);
    droneLP.connect(droneGain);
    droneGain.connect(master);
    drone.start();

    // Simple ‚Äúkick/snare‚Äù using short noise bursts
    const bpm = 78;
    const interval = (60 / bpm) * 1000;
    let step = 0;

    beatTimer = setInterval(()=>{
      if(!ctx) return;

      // kick
      if(step % 4 === 0){
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = "sine";
        o.frequency.setValueAtTime(120, ctx.currentTime);
        o.frequency.exponentialRampToValueAtTime(55, ctx.currentTime + 0.08);
        g.gain.setValueAtTime(0.18, ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.12);
        o.connect(g); g.connect(master);
        o.start();
        o.stop(ctx.currentTime + 0.13);
      }

      // snare-ish
      if(step % 8 === 4){
        const n = ctx.createBufferSource();
        n.buffer = noiseBuf;
        const g = ctx.createGain();
        g.gain.setValueAtTime(0.08, ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.09);

        const hp = ctx.createBiquadFilter();
        hp.type = "highpass";
        hp.frequency.value = 1200;

        n.connect(hp); hp.connect(g); g.connect(master);
        n.start();
        n.stop(ctx.currentTime + 0.10);
      }

      step++;
    }, interval);

    lofiBtn.textContent = "üéß Lo-fi (on)";
  }

  function stopLofi(){
    audioOn = false;
    lofiBtn.textContent = "üéß Lo-fi (tap to enable)";
    if(beatTimer) clearInterval(beatTimer);
    beatTimer = null;
    try{
      if(drone) drone.stop();
    }catch(e){}
    drone = null;
    if(ctx){
      ctx.close();
      ctx = null;
    }
  }

  lofiBtn.addEventListener("click", async ()=>{
    // iOS needs a user gesture ‚Äî this click counts.
    if(!audioOn){
      startLofi();
    }else{
      stopLofi();
    }
  });

  // initial
  render();
</script>
</body>
</html>
