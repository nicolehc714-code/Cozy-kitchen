<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cozy Kitchen ‚Äî Rainy Night</title>

  <style>
    :root{
      --bg0:#061329;
      --bg1:#0b1f3a;
      --glass: rgba(255,255,255,0.08);
      --glass2: rgba(255,255,255,0.12);
      --stroke: rgba(255,255,255,0.10);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.70);
      --warm: 0; /* 0..1 from JS */
      --accent:#f2c46b;
      --accent2:#ffdf9a;
      --shadow: rgba(0,0,0,0.40);
      --radius: 18px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color: var(--text);
      background:
        radial-gradient(1200px 900px at 50% 20%, rgba(255,210,120, calc(var(--warm) * 0.28)), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow:hidden;
    }

    /* Scene wrap */
    #scene{
      position:relative;
      width:100%;
      height:100%;
      display:grid;
      place-items:center;
      padding:18px;
    }

    /* Rain */
    .rain{
      position:absolute;
      inset:0;
      pointer-events:none;
      opacity:0.9;
      filter: drop-shadow(0 10px 24px rgba(0,0,0,0.25));
    }
    .rain::before{
      content:"";
      position:absolute;
      inset:-40px;
      background:
        repeating-linear-gradient(
          115deg,
          rgba(255,255,255,0.0) 0px,
          rgba(255,255,255,0.0) 10px,
          rgba(255,255,255,0.18) 11px,
          rgba(255,255,255,0.0) 13px
        );
      transform: translateY(-30px);
      animation: rain 1.1s linear infinite;
      opacity:0.45;
    }
    @keyframes rain{
      to{ transform: translateY(90px); }
    }

    /* Main panel */
    .panel{
      width:min(520px, 100%);
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,0.09), rgba(255,255,255,0.05));
      border-radius: 24px;
      box-shadow: 0 24px 60px rgba(0,0,0,0.35);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      overflow:hidden;
      position:relative;
    }

    .topbar{
      padding:16px 18px 10px;
      border-bottom:1px solid var(--stroke);
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      letter-spacing:0.18em;
      text-transform:uppercase;
      font-size:12px;
      color: rgba(255,255,255,0.70);
    }

    .content{
      padding:16px 18px 18px;
      display:grid;
      gap:12px;
    }

    /* Order row */
    .orderRow{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:12px;
      align-items:center;
      padding:12px;
      border:1px solid var(--stroke);
      background: var(--glass);
      border-radius: var(--radius);
    }
    .orderBox{
      display:grid;
      gap:6px;
    }
    .orderTitle{
      font-size:12px;
      color: var(--muted);
    }
    #orderLine{
      font-size:22px;
      font-weight:700;
      letter-spacing:0.01em;
    }
    #orderSub{
      font-size:13px;
      color: var(--muted);
    }
    #ingredient{
      font-size:60px;
      line-height:1;
      filter: drop-shadow(0 10px 16px rgba(0,0,0,0.25));
      padding:8px 10px;
    }

    /* Pot + steam */
    .potWrap{
      position:relative;
      padding:14px;
      border:1px solid var(--stroke);
      background: var(--glass);
      border-radius: var(--radius);
      min-height:120px;
      display:grid;
      place-items:center;
    }
    .pot{
      width:220px;
      height:72px;
      border-radius: 0 0 28px 28px;
      border:1px solid rgba(255,255,255,0.12);
      background: linear-gradient(180deg, rgba(255,255,255,0.12), rgba(0,0,0,0.10));
      position:relative;
      overflow:hidden;
    }
    .pot::before{
      content:"";
      position:absolute;
      inset:-20px 10px auto 10px;
      height:34px;
      border-radius: 22px;
      border:1px solid rgba(255,255,255,0.10);
      background: radial-gradient(120px 24px at 50% 40%, rgba(255,255,255,0.10), rgba(255,255,255,0.02));
      transform: translateY(14px);
      animation: simmer 2.1s ease-in-out infinite;
    }
    @keyframes simmer{
      0%{ transform: translateY(16px); opacity:0.75; }
      50%{ transform: translateY(10px); opacity:0.95; }
      100%{ transform: translateY(16px); opacity:0.75; }
    }

    #steam{
      position:absolute;
      inset:0;
      pointer-events:none;
    }
    .steamPuff{
      position:absolute;
      left:50%;
      top:36px;
      width:18px;
      height:18px;
      border-radius: 999px;
      background: rgba(255,255,255,0.20);
      filter: blur(0.2px);
      transform: translate(-50%, 0);
      animation: puff 1.6s ease-out forwards;
    }
    @keyframes puff{
      0%{ opacity:0.0; transform: translate(-50%, 12px) scale(0.8); }
      15%{ opacity:0.70; }
      100%{ opacity:0.0; transform: translate(calc(-50% + var(--dx)), -46px) scale(1.8); }
    }

    /* Chef */
    .chefStage{
      border:1px solid var(--stroke);
      background: var(--glass);
      border-radius: var(--radius);
      padding:14px;
      display:grid;
      place-items:center;
      min-height:140px;
      position:relative;
      overflow:hidden;
    }
    #chef{
      font-size:84px;
      line-height:1;
      transform-origin: 50% 70%;
      filter: drop-shadow(0 12px 18px rgba(0,0,0,0.30));
      user-select:none;
      -webkit-user-select:none;
    }
    #chef.chop{
      animation: chop 0.18s ease-in-out 0s 2 alternate;
    }
    @keyframes chop{
      from{ transform: rotate(-6deg) translateY(0); }
      to{ transform: rotate(8deg) translateY(2px); }
    }

    /* Dialogue */
    .dialogue{
      border:1px solid var(--stroke);
      background: var(--glass);
      border-radius: var(--radius);
      padding:12px 12px;
      display:flex;
      gap:10px;
      align-items:flex-start;
    }
    .name{
      font-weight:800;
      color: var(--accent2);
      min-width:64px;
    }
    #dialogueLine{
      color: rgba(255,255,255,0.85);
      font-style: italic;
      line-height:1.35;
    }

    /* HUD row */
    .hud{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
    }
    .chip{
      border:1px solid var(--stroke);
      background: rgba(0,0,0,0.12);
      border-radius: 999px;
      padding:10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      font-size:14px;
      color: rgba(255,255,255,0.84);
    }
    .chip b{ font-size:16px; }

    /* Buttons */
    .btnRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    button{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,0.06);
      color: var(--text);
      padding:14px 14px;
      border-radius: 14px;
      font-size:16px;
      font-weight:700;
      letter-spacing:0.02em;
      box-shadow: 0 10px 24px rgba(0,0,0,0.20);
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    #chopBtn{
      background: linear-gradient(180deg, var(--accent2), var(--accent));
      color:#1b1b1b;
      border: none;
    }
    #soundBtn{
      grid-column:1 / -1;
      font-weight:700;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
    }

    /* FX pop */
    #sliceFx{
      position:absolute;
      inset:0;
      pointer-events:none;
    }
    .fx{
      position:absolute;
      left:50%;
      top:50%;
      transform: translate(-50%, -50%);
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.18);
      color: rgba(255,255,255,0.90);
      font-weight:700;
      animation: pop 0.65s ease-out forwards;
      box-shadow: 0 12px 30px rgba(0,0,0,0.22);
    }
    @keyframes pop{
      from{ opacity:0; transform: translate(-50%, -40%) scale(0.96); }
      25%{ opacity:1; }
      to{ opacity:0; transform: translate(-50%, -70%) scale(1.05); }
    }

    .hint{
      text-align:center;
      font-size:12px;
      color: rgba(255,255,255,0.65);
      margin-top:-2px;
    }

  </style>
</head>

<body>
  <div id="scene">
    <div class="rain" aria-hidden="true"></div>

    <div class="panel">
      <div class="topbar">COZY KITCHEN ‚Ä¢ OPEN LATE ‚Ä¢ RAINY NIGHT</div>

      <div class="content">

        <div class="orderRow">
          <div class="orderBox">
            <div class="orderTitle">Order</div>
            <div id="orderLine">Tomato √ó 3</div>
            <div id="orderSub">Keep your rhythm.</div>
          </div>
          <div id="ingredient" aria-label="ingredient">üçÖ</div>
        </div>

        <div class="potWrap">
          <div id="steam"></div>
          <div class="pot" aria-label="pot"></div>
          <div class="hint">simmer‚Ä¶</div>
        </div>

        <div class="chefStage">
          <div id="sliceFx"></div>
          <div id="chef" aria-label="chef">üßë‚Äçüç≥</div>
        </div>

        <div class="dialogue">
          <div class="name">Mara</div>
          <div id="dialogueLine">‚ÄúRain makes the kitchen feel quieter.‚Äù</div>
        </div>

        <div class="hud">
          <div class="chip">üß° Warmth <b id="warmth">0</b></div>
          <div class="chip">üí∞ Tips <b id="tips">0</b></div>
          <div class="chip">üî• Streak <b id="streak">0</b></div>
        </div>

        <div class="btnRow">
          <button id="chopBtn">CHOP</button>
          <button id="newBtn">New Ingredient</button>
        </div>

        <button id="soundBtn">üîá Lo-fi (tap to enable)</button>
        <div class="hint" id="audioHint">On iPhone, sound starts only after a tap.</div>

      </div>
    </div>
  </div>

  <script>
    const chef = document.getElementById("chef");
    const ingEl = document.getElementById("ingredient");
    const fx = document.getElementById("sliceFx");
    const steam = document.getElementById("steam");

    const warmthEl = document.getElementById("warmth");
    const tipsEl = document.getElementById("tips");
    const streakEl = document.getElementById("streak");
    const orderLine = document.getElementById("orderLine");
    const orderSub = document.getElementById("orderSub");
    const dialogueLine = document.getElementById("dialogueLine");

    const chopBtn = document.getElementById("chopBtn");
    const newBtn = document.getElementById("newBtn");
    const soundBtn = document.getElementById("soundBtn");
    const audioHint = document.getElementById("audioHint");

    let warmth = 0, tips = 0, streak = 0;

    // Start muted (iOS autoplay rules)
    let muted = true;
    let audioCtx = null;
    let musicOn = false;
    let timers = [];
    let unlocked = false;

    /* ===== Cozy dialogue beats ===== */
    const cozyLines = [
      "‚ÄúRain makes the kitchen feel quieter.‚Äù",
      "‚ÄúThat simmer‚Ä¶ it‚Äôs kind of comforting.‚Äù",
      "‚ÄúYou‚Äôre doing good. Don‚Äôt rush.‚Äù",
      "‚ÄúIt smells like home in here.‚Äù",
      "‚ÄúOkay‚Ä¶ that was clean.‚Äù"
    ];
    let li = 0;
    function nextLine(){
      li = (li+1) % cozyLines.length;
      dialogueLine.textContent = cozyLines[li];
    }

    /* ===== Order system ===== */
    const ingredients = ["üçÖ","üßÖ","üßÑ","üåø","ü´ë","ü•ï","üçÑ","üßÄ"];
    const names = {"üçÖ":"Tomato","üßÖ":"Onion","üßÑ":"Garlic","üåø":"Herb","ü´ë":"Pepper","ü•ï":"Carrot","üçÑ":"Mushroom","üßÄ":"Cheese"};
    let current = "üçÖ";
    let remaining = 3;

    function setHud(){
      warmthEl.textContent = warmth;
      tipsEl.textContent = tips;
      streakEl.textContent = streak;
      const w = Math.max(0, Math.min(1, warmth/100));
      document.documentElement.style.setProperty("--warm", w.toFixed(3));
    }

    function setOrder(){
      orderLine.textContent = `${names[current]} √ó ${remaining}`;
      orderSub.textContent = remaining <= 1 ? "Last one. Make it nice." : "Keep your rhythm.";
      ingEl.textContent = current;
    }

    function pop(text){
      const p = document.createElement("div");
      p.className = "fx";
      p.textContent = text;
      fx.appendChild(p);
      setTimeout(()=>p.remove(), 650);
    }

    /* ===== Steam particles ===== */
    function spawnSteam(){
      const count = 1 + Math.floor(warmth/40); // 1..3
      for(let i=0;i<count;i++){
        const puff = document.createElement("div");
        puff.className = "steamPuff";
        puff.style.setProperty("--dx", (Math.random()*90 - 45) + "px");
        const s = 14 + Math.random()*12;
        puff.style.width = s+"px";
        puff.style.height = s+"px";
        puff.style.animationDuration = (1.2 + Math.random()*0.9) + "s";
        steam.appendChild(puff);
        setTimeout(()=>puff.remove(), 2000);
      }
    }

    /* ===== Audio (iOS-safe unlock) ===== */
    function ensureAudio(){
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }

    async function unlockAudio(){
      try{
        ensureAudio();
        if (audioCtx.state === "suspended") await audioCtx.resume();
        unlocked = true;
        audioHint.textContent = "Audio unlocked.";
        setTimeout(()=> audioHint.textContent = "", 1200);
      }catch(e){
        audioHint.textContent = "Audio blocked‚Äîtry tapping Lo-fi again.";
      }
    }

    // extra safety: unlock on first tap anywhere
    window.addEventListener("pointerdown", unlockAudio, { once:true });

    function playClick(good=true){
      if (muted || !audioCtx || audioCtx.state !== "running") return;
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = "triangle";
      o.frequency.value = good ? 740 : 220;
      g.gain.value = 0.0001;
      o.connect(g); g.connect(audioCtx.destination);
      const t = audioCtx.currentTime;
      g.gain.setValueAtTime(0.0001, t);
      g.gain.exponentialRampToValueAtTime(0.08, t+0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, t+0.12);
      o.start(t); o.stop(t+0.13);
    }

    function startLofi(){
      ensureAudio();
      if (musicOn) return;
      musicOn = true;

      const bpm = 74;
      const beatMs = (60000 / bpm) / 2; // 8th notes

      const master = audioCtx.createGain();
      master.gain.value = 0.35;
      master.connect(audioCtx.destination);

      const lp = audioCtx.createBiquadFilter();
      lp.type = "lowpass";
      lp.frequency.value = 1400;
      lp.connect(master);

      // Noise buffer
      const bufferSize = 2 * audioCtx.sampleRate;
      const noiseBuffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
      const out = noiseBuffer.getChannelData(0);
      for (let i = 0; i < bufferSize; i++) out[i] = (Math.random() * 2 - 1) * 0.25;

      // Rain bed
      const noise = audioCtx.createBufferSource();
      noise.buffer = noiseBuffer;
      noise.loop = true;

      const rainGain = audioCtx.createGain();
      rainGain.gain.value = 0.05;

      const rainLP = audioCtx.createBiquadFilter();
      rainLP.type = "lowpass";
      rainLP.frequency.value = 900;

      noise.connect(rainLP);
      rainLP.connect(rainGain);
      rainGain.connect(lp);
      noise.start();

      // Simmer bubbles
      const simmerGain = audioCtx.createGain();
      simmerGain.gain.value = 0.06;
      simmerGain.connect(lp);

      function bubble(){
        if (!musicOn) return;
        const n = audioCtx.createBufferSource();
        n.buffer = noiseBuffer;
        const g = audioCtx.createGain();
        g.gain.value = 0.0001;

        const f = audioCtx.createBiquadFilter();
        f.type = "bandpass";
        f.frequency.value = 220 + Math.random()*140;
        f.Q.value = 8;

        n.connect(f); f.connect(g); g.connect(simmerGain);

        const t = audioCtx.currentTime;
        g.gain.setValueAtTime(0.0001, t);
        g.gain.exponentialRampToValueAtTime(0.12, t+0.02);
        g.gain.exponentialRampToValueAtTime(0.0001, t+0.14);

        n.start(t);
        n.stop(t+0.16);

        timers.push(setTimeout(bubble, 450 + Math.random()*650));
      }
      bubble();

      // Chords
      const chordProg = [
        [261.63, 329.63, 392.00],
        [233.08, 293.66, 349.23],
        [220.00, 277.18, 329.63],
        [196.00, 246.94, 293.66]
      ];
      let step = 0;

      function playChord(freqs){
        const t = audioCtx.currentTime;
        freqs.forEach((freq, i) => {
          const o = audioCtx.createOscillator();
          const g = audioCtx.createGain();
          o.type = "triangle";
          o.frequency.value = freq * (i===0 ? 0.5 : 1);
          g.gain.value = 0.0001;
          o.connect(g); g.connect(lp);

          g.gain.setValueAtTime(0.0001, t);
          g.gain.exponentialRampToValueAtTime(0.07, t+0.05);
          g.gain.exponentialRampToValueAtTime(0.0001, t+1.8);

          o.start(t);
          o.stop(t+2.0);
        });
      }

      // Simple drums
      function kick(){
        const t = audioCtx.currentTime;
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.type = "sine";
        o.frequency.setValueAtTime(110, t);
        o.frequency.exponentialRampToValueAtTime(45, t+0.08);
        g.gain.setValueAtTime(0.0001, t);
        g.gain.exponentialRampToValueAtTime(0.18, t+0.01);
        g.gain.exponentialRampToValueAtTime(0.0001, t+0.12);
        o.connect(g); g.connect(lp);
        o.start(t); o.stop(t+0.13);
      }
      function snare(){
        const t = audioCtx.currentTime;
        const n = audioCtx.createBufferSource();
        n.buffer = noiseBuffer;
        const hp = audioCtx.createBiquadFilter();
        hp.type = "highpass";
        hp.frequency.value = 1200;
        const g = audioCtx.createGain();
        g.gain.setValueAtTime(0.0001, t);
        g.gain.exponentialRampToValueAtTime(0.10, t+0.01);
        g.gain.exponentialRampToValueAtTime(0.0001, t+0.10);
        n.connect(hp); hp.connect(g); g.connect(lp);
        n.start(t); n.stop(t+0.11);
      }
      function hat(){
        const t = audioCtx.currentTime;
        const n = audioCtx.createBufferSource();
        n.buffer = noiseBuffer;
        const hp = audioCtx.createBiquadFilter();
        hp.type = "highpass";
        hp.frequency.value = 5000;
        const g = audioCtx.createGain();
        g.gain.setValueAtTime(0.0001, t);
        g.gain.exponentialRampToValueAtTime(0.045, t+0.005);
        g.gain.exponentialRampToValueAtTime(0.0001, t+0.03);
        n.connect(hp); hp.connect(g); g.connect(lp);
        n.start(t); n.stop(t+0.04);
      }

      let tick = 0;
      function scheduler(){
        if (!musicOn) return;

        if (tick % 16 === 0){
          playChord(chordProg[step % chordProg.length]);
          step++;
        }

        if (tick % 8 === 0) kick();
        if (tick % 8 === 4) snare();
        if (tick % 2 === 0) hat();

        tick++;
        timers.push(setTimeout(scheduler, beatMs));
      }
      scheduler();

      startLofi._noise = noise;
    }

    function stopLofi(){
      musicOn = false;
      timers.forEach(clearTimeout);
      timers = [];
      try { startLofi._noise?.stop(); } catch(e){}
    }

    /* ===== Gameplay ===== */
    function newIngredient(forceNewOrder=false){
      if (forceNewOrder){
        current = ingredients[Math.floor(Math.random()*ingredients.length)];
        remaining = 2 + Math.floor(Math.random()*4);
        streak = 0;
        setHud();
        setOrder();
        return;
      }
      current = ingredients[Math.floor(Math.random()*ingredients.length)];
      setOrder();
    }

    function chop(){
      chef.classList.remove("chop");
      void chef.offsetWidth;
      chef.classList.add("chop");

      spawnSteam();

      remaining -= 1;
      streak += 1;

      const gainWarmth = 3 + Math.min(10, Math.floor(streak/2));
      warmth = Math.min(100, warmth + gainWarmth);
      tips += 1 + Math.min(7, Math.floor(streak/3));

      pop(`+${gainWarmth} warmth`);
      playClick(true);
      setHud();

      if (remaining <= 0){
        pop("ORDER UP!");
        tips += 10;
        warmth = Math.min(100, warmth + 8);
        nextLine();
        playClick(true);
        newIngredient(true);
      } else {
        if (streak % 4 === 0) nextLine();
        setOrder();
      }
    }

    soundBtn.addEventListener("click", async () => {
      await unlockAudio();
      muted = !muted;

      if (muted){
        soundBtn.textContent = "üîá Lo-fi (tap to enable)";
        stopLofi();
      } else {
        soundBtn.textContent = "üîä Lo-fi (on)";
        startLofi();
      }
    });

    chopBtn.addEventListener("click", async () => {
      await unlockAudio();
      chop();
    });

    newBtn.addEventListener("click", () => newIngredient(false));

    setInterval(() => {
      if (warmth > 0) spawnSteam();
    }, 900);

    // init
    setHud();
    setOrder();
  </script>
</body>
</html>
